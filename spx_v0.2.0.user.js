// ==UserScript==
// @name SkyPlanX
// @description This extension (by Ethan Shields) allows you to export routes to formats compatible for GEFS and FSX.
// @match https://*.skyvector.com/*
// @run-at document-end
// @version 0.2.0
// @grant none
// ==/UserScript==

// Copyright (c) 2015 Ethan Shields.  All Rights Reserved.
console.log("Copyright (c) 2015 Ethan Shields.  All Rights Reserved.");

function generateFile(){var e,t=SkyVector.data.FPL,n=t.alt,r=t.dep.aptid,o=convertCoords(t.dep.lat,t.dep.lon,t.dep.elev),a=t.dst.aptid,i=convertCoords(t.dst.lat,t.dst.lon,t.dst.elev),l=r+" to "+a,u=l+" created by SkyVector and SkyPlanX";e=t.dep.rwy?convertRwy(t.dep.rwy):"";var c=t.dep.name,d=t.dst.name;n=n?convertCrz(n):"35000";for(var p='<?xml version="1.0" encoding="UTF-8"?>\n\n<SimBase.Document Type="AceXML" version="1,0">\n<Descr>AceXML Document</Descr>\n<FlightPlan.FlightPlan>\n',s=p,v=["Title","FPType","RouteType","CruisingAlt","DepartureID","DepartureLLA","DestinationID","DestinationLLA","Descr","DeparturePosition","DepartureName","DestinationName"],h=[l,"IFR","HighAlt",n,r,o,a,i,u,e,c,d],g=0;g<v.length;g++)s+=createTag(v[g],h[g]);s+="<AppVersion>\n<AppVersionMajor>10</AppVersionMajor>\n<AppVersionBuild>61472</AppVersionBuild>\n</AppVersion>\n\n";var f=[];f.push([t.route[0].ident,t.route[0].lat,t.route[0].lon,t.route[0].elev]);for(var g=1;g<t.route.length;g++)if(t.route[g].route&&t.route[g].route.length)for(var y=t.route[g].route,A=0;A<y.length;A++)0==A&&y[0].ident==f[f.length-1][0]&&A++,f.push([y[A].ident,y[A].lat,y[A].lon]);else t.route[g].ident==t.route[g-1].ident&&g++,f.push([t.route[g].ident,t.route[g].lat,t.route[g].lon]);f.push([t.route[t.route.length-1].ident,t.route[t.route.length-1].lat,t.route[t.route.length-1].lon,t.route[t.route.length-1].elev]);for(var g=0;g<f.length;g++)s+=createWaypoint(f[g]);s+="</FlightPlan.FlightPlan>\n</SimBase.Document>\n";var m=document.createElement("a");m.href="data:attachment/text,"+encodeURI(s),m.target="_blank",m.download=l+".pln";var D=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});m.dispatchEvent(D)}function convertCrz(e){return e.indexOf("FL")>-1?(e=e.split("L")[1],e+="00"):void 0}function convertRwy(e){return e.replace("RW",""),e}function convertPoint(e,t){"string"==typeof e&&(e=Number(e));var n;n=t?e>=0?"E":"W":e>=0?"N":"S",0>e&&(e=Math.abs(e));var r=e,o=Math.floor(r),a=60*(r-o),i=Math.floor(a),l=60*(a-i),u=Math.round(100*l)/100;180==o&&(o=179,i=59,u=59.99),60==u&&(u="0",i++),60==i&&(i=0,o++),0>o&&(o=Math.abs(o));var c=n+o+"Â° "+i+"' "+u+'"';return c}function convertAlt(e){"number"==typeof e&&(e+="");var t;t=Number(e)>=0?"+":"-";for(var n=e.split("."),r=n[0],o=n[1],a=0;a<6-r.length;a++)t+="0";return t+=r+"."+o+"0"}function convertCoords(e,t,n){return e=convertPoint(e,0),t=convertPoint(t,1),n=convertAlt(n),e+","+t+","+n}function createTag(e,t){return"<"+e+">"+t+"</"+e+">\n"}function createWaypoint(e){var t,n=e[0],r=checkWaypoint(n);t=e[3]?e[3]:"0.0";var o=convertCoords(e[1],e[2],t),a='<ATCWaypoint id="'+n+'">\n';return a+=createTag("ATCWaypointType",r),a+=createTag("WorldPosition",o)+"<ICAO>\n",a+=createTag("ICAOIdent",n)+"</ICAO>\n</ATCWaypoint>\n\n"}function checkWaypoint(e){var t,n=e.length;return t=3>=n?"VOR":4==n?"Airport":"Intersection"}window.addEventListener("load",function(){var e=document.createElement("li"),t=document.createTextNode("Export Flight Plan");e.appendChild(t),e.onclick=generateFile,e.setAttribute("class","ul");var n=document.getElementById("sv_topbarul");n.insertBefore(e,n.childNodes[3])},!1);

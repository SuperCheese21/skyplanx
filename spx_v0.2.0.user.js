// ==UserScript==
// @name SkyPlanX
// @description This extension (by Ethan Shields) allows you to export routes to formats compatible for GEFS and FSX.
// @match https://*.skyvector.com/*
// @run-at document-end
// @version 0.2.0
// @grant none
// ==/UserScript==

// Copyright (c) 2016 Ethan Shields.  All Rights Reserved.
console.log("Copyright (c) 2016 Ethan Shields.  All Rights Reserved.");

!function(e){var t=setInterval(function(){var n=[$,document.getElementsByClassName("svfpl_toolbar")[0]];n.every(function(e){return e})&&(e(),clearInterval(t))},100)}(function(){$(".svfpl_switch").css("margin","0px 0px 0px 111px"),spx.ui.toolbarIcon=$("<a>").addClass("svfpl_iconlinkbtn").attr("title","Export to Flight Sim").click(spx.gen.fsx).append($("<span>").addClass("fa fa-plane")).insertAfter($(".svfpl_iconlinkbtn").eq(3)),spx.ui.menu=$("<div>").addClass("tppMenu").css({top:"130px",left:"225px"}).append($("<table>").addClass("tppMenu").append($("<tr>").addClass("tppMenu").append($("<th>").addClass("tppMenu").text("Export To...")),$("<tr>").addClass("tppMenu").append($("<td>").addClass("tppMenu gefs").text("GEFS-Online")),$("<tr>").addClass("tppMenu").append($("<td>").addClass("tppMenu pln").text("FSX/P3D")),$("<tr>").addClass("tppMenu").append($("<td>").addClass("tppMenu qw757").text("QualityWings 757")),$("<tr>").addClass("tppMenu").append($("<td>").addClass("tppMenu asa").text("Aerosoft Airbus")))).appendTo("body")}),window.spx={formatsList:["fsx","gefs","qw","asa","as16"],gen:{},global:{},lib:{},ui:{}},spx.formatsList.forEach(function(e){spx.gen[e]={lib:{}}}),spx.gen.fsx.build=function(){for(var e=SkyVector.data.FPL,t=e.alt?spx.gen.fsx.lib.convertCrz(e.alt):"35000",n=e.dep.aptid,r=spx.gen.fsx.lib.convertCoords(e.dep.lat,e.dep.lon,e.dep.elev),a=e.dst.aptid,o=spx.gen.fsx.lib.convertCoords(e.dst.lat,e.dst.lon,e.dst.elev),s=n+" to "+a,p=s+" - route created by SkyVector and SkyPlanX",l=e.dep.rwy?spx.gen.fsx.lib.convertRwy(e.dep.rwy):"",i=e.dep.name,u=e.dst.name,d='<?xml version="1.0" encoding="UTF-8"?>\n\n<SimBase.Document Type="AceXML" version="1,0">\n<Descr>AceXML Document</Descr>\n<FlightPlan.FlightPlan>\n',c=d,f=["Title","FPType","RouteType","CruisingAlt","DepartureID","DepartureLLA","DestinationID","DestinationLLA","Descr","DeparturePosition","DepartureName","DestinationName"],x=[s,"IFR","HighAlt",t,n,r,a,o,p,l,i,u],g=0;g<f.length;g++)c+=spx.gen.fsx.lib.createTag(f[g],x[g]);c+="<AppVersion>\n<AppVersionMajor>10</AppVersionMajor>\n<AppVersionBuild>61472</AppVersionBuild>\n</AppVersion>\n\n";var v=[];v.push([e.route[0].ident,e.route[0].lat,e.route[0].lon,e.route[0].elev]);for(var g=1;g<e.route.length;g++)if(e.route[g].route&&e.route[g].route.length)for(var b=e.route[g].route,h=0;h<b.length;h++)0===h&&b[0].ident==v[v.length-1][0]&&h++,v.push([b[h].ident,b[h].lat,b[h].lon]);else e.route[g].ident==e.route[g-1].ident&&g++,v.push([e.route[g].ident,e.route[g].lat,e.route[g].lon]);v.push([e.route[e.route.length-1].ident,e.route[e.route.length-1].lat,e.route[e.route.length-1].lon,e.route[e.route.length-1].elev]);for(var g=0;g<v.length;g++)c+=spx.gen.fsx.lib.createWaypoint(v[g]);c+="</FlightPlan.FlightPlan>\n</SimBase.Document>\n";var C=document.createElement("a");C.href="data:attachment/text,"+encodeURI(c),C.target="_blank",C.download=s+".pln";var y=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});C.dispatchEvent(y)},spx.gen.fsx.lib.convertCoords=function(e,t,n){return e=this.convertPoint(e,0),t=this.convertPoint(t,1),n=this.convertElev(n),e+","+t+","+n},spx.gen.fsx.lib.convertCrz=function(e){if(e.indexOf("FL")>-1){e.replace("FL","");var t=e+"00";return t}},spx.gen.fsx.lib.convertElev=function(e){"number"==typeof e&&(e+="");for(var t=Number(e)>=0?"+":"-",n=e.split("."),r=n[0],a=n[1],o=0;o<6-r.length;o++)t+="0";return t+=r+"."+a+"0"},spx.gen.fsx.lib.convertPoint=function(e,t){"string"==typeof e&&(e=Number(e));var n;n=t?e>=0?"E":"W":e>=0?"N":"S",0>e&&(e=Math.abs(e));var r=e,a=Math.floor(r),o=60*(r-a),s=Math.floor(o),p=60*(o-s),l=Math.round(100*p)/100;60==l&&(l=0,s++),60==s&&(s=0,a++),180==a&&(a=179,s=59,l=59.99),0>a&&(a=Math.abs(a));var i=n+a+"Â° "+s+"' "+l+'"';return i},spx.gen.fsx.lib.createTag=function(e,t){return"<"+e+">"+t+"</"+e+">\n"},spx.gen.fsx.lib.createWaypoint=function(e){var t=e[0],n=spx.global.getType(t),r=e[3]||"0.0",a=spx.gen.fsx.lib.convertCoords(e[1],e[2],r),o='<ATCWaypoint id="'+t+'">\n',s=spx.gen.fsx.lib.createTag;return o+=s("ATCWaypointType",n),o+=s("WorldPosition",a)+"<ICAO>\n",o+=s("ICAOIdent",t)+"</ICAO>\n</ATCWaypoint>\n\n"},spx.global.convertRwy=function(e){return e=e.replace("RW","")},spx.global.getType=function(e){var t,n=e.length;return t=3>=n?"VOR":4==n?"Airport":"Intersection"};

// ==UserScript==
// @name SkyPlanX
// @description This extension (by Ethan Shields) allows you to export routes to formats compatible for GEFS and FSX.
// @match https://*.skyvector.com/*
// @run-at document-end
// @version 0.2.0
// @grant none
// ==/UserScript==

// Copyright (c) 2016 Ethan Shields.  All Rights Reserved.
console.log("Copyright (c) 2016 Ethan Shields.  All Rights Reserved.");

window.spx={},spx.timer=setInterval(function(){var e=document.getElementsByClassName("svfpl_toolbar")[0];e&&(spx.appendButton(),clearInterval(spx.timer))},100),spx.appendButton=function(){var e=document.createElement("a");e.className="svfpl_iconlinkbtn",e.title="Export to Flight Sim",e.onclick=spx.generatePLN;var t=document.createElement("span");t.className="fa fa-plane",e.appendChild(t);var n=document.getElementsByClassName("svfpl_toolbar")[0];n.childNodes[4].style.margin="0px 0px 0px 111px",n.insertBefore(e,n.childNodes[4])},spx.generatePLN=function(){for(var e=SkyVector.data.FPL,t=e.alt?spx.lib.convertCrz(e.alt):"35000",n=e.dep.aptid,r=spx.lib.convertCoords(e.dep.lat,e.dep.lon,e.dep.elev),o=e.dst.aptid,a=spx.lib.convertCoords(e.dst.lat,e.dst.lon,e.dst.elev),l=n+" to "+o,i=l+" - route created by SkyVector and SkyPlanX",p=e.dep.rwy?spx.lib.convertRwy(e.dep.rwy):"",s=e.dep.name,u=e.dst.name,c='<?xml version="1.0" encoding="UTF-8"?>\n\n<SimBase.Document Type="AceXML" version="1,0">\n<Descr>AceXML Document</Descr>\n<FlightPlan.FlightPlan>\n',d=c,v=["Title","FPType","RouteType","CruisingAlt","DepartureID","DepartureLLA","DestinationID","DestinationLLA","Descr","DeparturePosition","DepartureName","DestinationName"],x=[l,"IFR","HighAlt",t,n,r,o,a,i,p,s,u],m=0;m<v.length;m++)d+=spx.xml.createTag(v[m],x[m]);d+="<AppVersion>\n<AppVersionMajor>10</AppVersionMajor>\n<AppVersionBuild>61472</AppVersionBuild>\n</AppVersion>\n\n";var h=[];h.push([e.route[0].ident,e.route[0].lat,e.route[0].lon,e.route[0].elev]);for(var m=1;m<e.route.length;m++)if(e.route[m].route&&e.route[m].route.length)for(var g=e.route[m].route,f=0;f<g.length;f++)0===f&&g[0].ident==h[h.length-1][0]&&f++,h.push([g[f].ident,g[f].lat,g[f].lon]);else e.route[m].ident==e.route[m-1].ident&&m++,h.push([e.route[m].ident,e.route[m].lat,e.route[m].lon]);h.push([e.route[e.route.length-1].ident,e.route[e.route.length-1].lat,e.route[e.route.length-1].lon,e.route[e.route.length-1].elev]);for(var m=0;m<h.length;m++)d+=spx.xml.createWaypoint(h[m]);d+="</FlightPlan.FlightPlan>\n</SimBase.Document>\n";var b=document.createElement("a");b.href="data:attachment/text,"+encodeURI(d),b.target="_blank",b.download=l+".pln";var y=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});b.dispatchEvent(y)},spx.lib={},spx.lib.convertCrz=function(e){if(e.indexOf("FL")>-1){e.replace("FL","");var t=e+"00";return t}},spx.lib.convertRwy=function(e){return e=e.replace("RW","")},spx.lib.convertPoint=function(e,t){"string"==typeof e&&(e=Number(e));var n;n=t?e>=0?"E":"W":e>=0?"N":"S",0>e&&(e=Math.abs(e));var r=e,o=Math.floor(r),a=60*(r-o),l=Math.floor(a),i=60*(a-l),p=Math.round(100*i)/100;60==p&&(p=0,l++),60==l&&(l=0,o++),180==o&&(o=179,l=59,p=59.99),0>o&&(o=Math.abs(o));var s=n+o+"Â° "+l+"' "+p+'"';return s},spx.lib.convertElev=function(e){"number"==typeof e&&(e+="");for(var t=Number(e)>=0?"+":"-",n=e.split("."),r=n[0],o=n[1],a=0;a<6-r.length;a++)t+="0";return t+=r+"."+o+"0"},spx.lib.convertCoords=function(e,t,n){return e=this.convertPoint(e,0),t=this.convertPoint(t,1),n=this.convertElev(n),e+","+t+","+n},spx.lib.getType=function(e){var t,n=e.length;return t=3>=n?"VOR":4==n?"Airport":"Intersection"},spx.xml={},spx.xml.createTag=function(e,t){return"<"+e+">"+t+"</"+e+">\n"},spx.xml.createWaypoint=function(e){var t=e[0],n=spx.lib.getType(t),r=e[3]||"0.0",o=spx.lib.convertCoords(e[1],e[2],r),a='<ATCWaypoint id="'+t+'">\n',l=spx.xml.createTag;return a+=l("ATCWaypointType",n),a+=l("WorldPosition",o)+"<ICAO>\n",a+=l("ICAOIdent",t)+"</ICAO>\n</ATCWaypoint>\n\n"};

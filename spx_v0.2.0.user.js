// ==UserScript==
// @name SkyPlanX
// @description This extension (by Ethan Shields) allows you to export routes to formats compatible for GEFS and FSX.
// @match https://*.skyvector.com/*
// @run-at document-end
// @version 0.2.0
// @grant none
// ==/UserScript==

// Copyright (c) 2016 Ethan Shields.  All Rights Reserved.
console.log("Copyright (c) 2016 Ethan Shields.  All Rights Reserved.");

function convertCrz(e){if(e.indexOf("FL")>-1){e.replace("FL","");var t=e+"00";return t}}function convertRwy(e){return e=e.replace("RW","")}function convertPoint(e,t){"string"==typeof e&&(e=Number(e));var n;n=t?e>=0?"E":"W":e>=0?"N":"S",0>e&&(e=Math.abs(e));var r=e,o=Math.floor(r),a=60*(r-o),l=Math.floor(a),i=60*(a-l),u=Math.round(100*i)/100;60==u&&(u=0,l++),60==l&&(l=0,o++),180==o&&(o=179,l=59,u=59.99),0>o&&(o=Math.abs(o));var c=n+o+"Â° "+l+"' "+u+'"';return c}function convertElev(e){"number"==typeof e&&(e+="");for(var t=Number(e)>=0?"+":"-",n=e.split("."),r=n[0],o=n[1],a=0;a<6-r.length;a++)t+="0";return t+=r+"."+o+"0"}function convertCoords(e,t,n){return e=convertPoint(e,0),t=convertPoint(t,1),n=convertElev(n),e+","+t+","+n}function createTag(e,t){return"<"+e+">"+t+"</"+e+">\n"}function createWaypoint(e){var t=e[0],n=getType(t),r=e[3]||"0.0",o=convertCoords(e[1],e[2],r),a='<ATCWaypoint id="'+t+'">\n';return a+=createTag("ATCWaypointType",n),a+=createTag("WorldPosition",o)+"<ICAO>\n",a+=createTag("ICAOIdent",t)+"</ICAO>\n</ATCWaypoint>\n\n"}function getType(e){var t,n=e.length;return t=3>=n?"VOR":4==n?"Airport":"Intersection"}var timer=setInterval(function(){var e=document.getElementsByClassName("svfpl_toolbar")[0];e&&(appendButton(),clearInterval(timer))},100),appendButton=function(){var e=document.createElement("a");e.className="svfpl_iconlinkbtn",e.title="Export to Flight Sim",e.onclick=generatePLN;var t=document.createElement("span");t.className="fa fa-plane",e.appendChild(t);var n=document.getElementsByClassName("svfpl_toolbar")[0];n.childNodes[4].style.margin="0px 0px 0px 111px",n.insertBefore(e,n.childNodes[4])},generatePLN=function(){for(var e=SkyVector.data.FPL,t=e.alt?convertCrz(t):"35000",n=e.dep.aptid,r=convertCoords(e.dep.lat,e.dep.lon,e.dep.elev),o=e.dst.aptid,a=convertCoords(e.dst.lat,e.dst.lon,e.dst.elev),l=n+" to "+o,i=l+" - route created by SkyVector and SkyPlanX",u=e.dep.rwy?convertRwy(e.dep.rwy):"",c=e.dep.name,p=e.dst.name,s='<?xml version="1.0" encoding="UTF-8"?>\n\n<SimBase.Document Type="AceXML" version="1,0">\n<Descr>AceXML Document</Descr>\n<FlightPlan.FlightPlan>\n',d=s,v=["Title","FPType","RouteType","CruisingAlt","DepartureID","DepartureLLA","DestinationID","DestinationLLA","Descr","DeparturePosition","DepartureName","DestinationName"],g=[l,"IFR","HighAlt",t,n,r,o,a,i,u,c,p],h=0;h<v.length;h++)d+=createTag(v[h],g[h]);d+="<AppVersion>\n<AppVersionMajor>10</AppVersionMajor>\n<AppVersionBuild>61472</AppVersionBuild>\n</AppVersion>\n\n";var m=[];m.push([e.route[0].ident,e.route[0].lat,e.route[0].lon,e.route[0].elev]);for(var h=1;h<e.route.length;h++)if(e.route[h].route&&e.route[h].route.length)for(var f=e.route[h].route,y=0;y<f.length;y++)0===y&&f[0].ident==m[m.length-1][0]&&y++,m.push([f[y].ident,f[y].lat,f[y].lon]);else e.route[h].ident==e.route[h-1].ident&&h++,m.push([e.route[h].ident,e.route[h].lat,e.route[h].lon]);m.push([e.route[e.route.length-1].ident,e.route[e.route.length-1].lat,e.route[e.route.length-1].lon,e.route[e.route.length-1].elev]);for(var h=0;h<m.length;h++)d+=createWaypoint(m[h]);d+="</FlightPlan.FlightPlan>\n</SimBase.Document>\n";var A=document.createElement("a");A.href="data:attachment/text,"+encodeURI(d),A.target="_blank",A.download=l+".pln";var C=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});A.dispatchEvent(C)};

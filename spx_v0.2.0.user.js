// ==UserScript==
// @name SkyPlanX
// @description This extension (by Ethan Shields) allows you to export routes to formats compatible for GEFS and FSX.
// @match https://*.skyvector.com/*
// @run-at document-end
// @version 0.2.0
// @grant none
// ==/UserScript==

// Copyright (c) 2016 Ethan Shields.  All Rights Reserved.
console.log("Copyright (c) 2016 Ethan Shields.  All Rights Reserved.");

window.spx={},spx.ui={},function(){var e=setInterval(function(){var t=[$,document.getElementsByClassName("svfpl_toolbar")[0],document.getElementById("chart")],n=t.every(function(e){return e});n&&(spx.init(),clearInterval(e))},100)}(),spx.init=function(){var e=($(".svfpl_toolbar")[0],$("#chart"));spx.ui.toolbarIcon=$("<a>").addClass("svfpl_iconlinkbtn").attr("title","Export to Flight Sim").click(spx.generatePLN).append($("<span>").addClass("fa fa-plane")).insertAfter($(".svfpl_iconlinkbtn").eq(3)),spx.ui.modal=$("<div>").addClass("svfpl_shareform").css({top:"74px",left:"79px",position:"absolute"}).append($("<h1>").addClass("sv sv_sharepanel").text("Export to Flight Sim")).appendTo(e),$(".svfpl_switch").css("margin","0px 0px 0px 111px")},spx.generatePLN=function(){for(var e=SkyVector.data.FPL,t=e.alt?spx.lib.convertCrz(e.alt):"35000",n=e.dep.aptid,r=spx.lib.convertCoords(e.dep.lat,e.dep.lon,e.dep.elev),o=e.dst.aptid,a=spx.lib.convertCoords(e.dst.lat,e.dst.lon,e.dst.elev),i=n+" to "+o,l=i+" - route created by SkyVector and SkyPlanX",s=e.dep.rwy?spx.lib.convertRwy(e.dep.rwy):"",p=e.dep.name,u=e.dst.name,c='<?xml version="1.0" encoding="UTF-8"?>\n\n<SimBase.Document Type="AceXML" version="1,0">\n<Descr>AceXML Document</Descr>\n<FlightPlan.FlightPlan>\n',d=c,v=["Title","FPType","RouteType","CruisingAlt","DepartureID","DepartureLLA","DestinationID","DestinationLLA","Descr","DeparturePosition","DepartureName","DestinationName"],x=[i,"IFR","HighAlt",t,n,r,o,a,l,s,p,u],h=0;h<v.length;h++)d+=spx.xml.createTag(v[h],x[h]);d+="<AppVersion>\n<AppVersionMajor>10</AppVersionMajor>\n<AppVersionBuild>61472</AppVersionBuild>\n</AppVersion>\n\n";var f=[];f.push([e.route[0].ident,e.route[0].lat,e.route[0].lon,e.route[0].elev]);for(var h=1;h<e.route.length;h++)if(e.route[h].route&&e.route[h].route.length)for(var g=e.route[h].route,m=0;m<g.length;m++)0===m&&g[0].ident==f[f.length-1][0]&&m++,f.push([g[m].ident,g[m].lat,g[m].lon]);else e.route[h].ident==e.route[h-1].ident&&h++,f.push([e.route[h].ident,e.route[h].lat,e.route[h].lon]);f.push([e.route[e.route.length-1].ident,e.route[e.route.length-1].lat,e.route[e.route.length-1].lon,e.route[e.route.length-1].elev]);for(var h=0;h<f.length;h++)d+=spx.xml.createWaypoint(f[h]);d+="</FlightPlan.FlightPlan>\n</SimBase.Document>\n";var b=document.createElement("a");b.href="data:attachment/text,"+encodeURI(d),b.target="_blank",b.download=i+".pln";var y=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});b.dispatchEvent(y)},spx.lib={},spx.lib.convertCrz=function(e){if(e.indexOf("FL")>-1){e.replace("FL","");var t=e+"00";return t}},spx.lib.convertRwy=function(e){return e=e.replace("RW","")},spx.lib.convertPoint=function(e,t){"string"==typeof e&&(e=Number(e));var n;n=t?e>=0?"E":"W":e>=0?"N":"S",0>e&&(e=Math.abs(e));var r=e,o=Math.floor(r),a=60*(r-o),i=Math.floor(a),l=60*(a-i),s=Math.round(100*l)/100;60==s&&(s=0,i++),60==i&&(i=0,o++),180==o&&(o=179,i=59,s=59.99),0>o&&(o=Math.abs(o));var p=n+o+"Â° "+i+"' "+s+'"';return p},spx.lib.convertElev=function(e){"number"==typeof e&&(e+="");for(var t=Number(e)>=0?"+":"-",n=e.split("."),r=n[0],o=n[1],a=0;a<6-r.length;a++)t+="0";return t+=r+"."+o+"0"},spx.lib.convertCoords=function(e,t,n){return e=this.convertPoint(e,0),t=this.convertPoint(t,1),n=this.convertElev(n),e+","+t+","+n},spx.lib.getType=function(e){var t,n=e.length;return t=3>=n?"VOR":4==n?"Airport":"Intersection"},spx.xml={},spx.xml.createTag=function(e,t){return"<"+e+">"+t+"</"+e+">\n"},spx.xml.createWaypoint=function(e){var t=e[0],n=spx.lib.getType(t),r=e[3]||"0.0",o=spx.lib.convertCoords(e[1],e[2],r),a='<ATCWaypoint id="'+t+'">\n',i=spx.xml.createTag;return a+=i("ATCWaypointType",n),a+=i("WorldPosition",o)+"<ICAO>\n",a+=i("ICAOIdent",t)+"</ICAO>\n</ATCWaypoint>\n\n"};
